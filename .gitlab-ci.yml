# GitLab CI/CD Pipeline for User CRUD API
# This pipeline builds, tests, and deploys a Spring Boot application with Docker

# Define stages
stages:
  - test
  - build
  - deploy-staging
  - deploy-production

# Global variables
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  APP_NAME: "user-crud-api"
  STAGING_PORT: "8080"
  PROD_PORT: "8081"
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository
    - target/

# Use Docker-in-Docker service
services:
  - docker:dind

# Before script - runs before each job
before_script:
  - echo "Starting pipeline for commit $CI_COMMIT_SHORT_SHA"

# ==================== TEST STAGE ====================

unit-tests:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  script:
    - echo "Running unit tests with coverage check..."
    - mvn clean test jacoco:report
    - echo "Checking coverage threshold..."
    - |
      COVERAGE=$(sed -n '/<tfoot>/,/<\/tfoot>/p' target/site/jacoco/index.html | grep -o '[0-9]\+%' | head -1 | tr -d '%')
      echo "Code Coverage: ${COVERAGE}%"
      if [ "$COVERAGE" -lt 80 ]; then
        echo "❌ Coverage ${COVERAGE}% is below the required 80% threshold"
        exit 1
      else
        echo "✅ Coverage ${COVERAGE}% meets the 80% threshold"
      fi
    - echo "✅ Unit tests passed with sufficient coverage"
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/jacoco/jacoco.xml
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    expire_in: 1 week
  coverage: '/Code Coverage: ([0-9]{1,3})%/'
  only:
    - branches
    - merge_requests

# ==================== BUILD STAGE ====================

build-docker-image:
  stage: build
  image: docker:latest
  script:
    - echo "Building Docker image..."
    - docker build -t $APP_NAME:$CI_COMMIT_SHORT_SHA .
    - docker tag $APP_NAME:$CI_COMMIT_SHORT_SHA $APP_NAME:latest
    - echo "✅ Docker image built successfully"
    - docker images | grep $APP_NAME
  only:
    - branches
    - merge_requests

push-to-registry:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Image pushed to $CI_REGISTRY_IMAGE"
  only:
    - main
    - master
    - develop

# ==================== CONTAINER TEST ====================

test-container:
  stage: deploy-staging
  image: docker:latest
  needs:
    - push-to-registry
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Testing Docker container from registry..."
    - echo "Pulling image from $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    
    # Pull image from registry
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    # Run container in test mode
    - docker run -d --name $APP_NAME-test -p 8080:8080 -e SPRING_PROFILES_ACTIVE=test $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    # Wait for startup
    - sleep 30
    
    # Check if container is running
    - docker ps | grep $APP_NAME-test
    
    # Show logs
    - echo "Container logs:"
    - docker logs $APP_NAME-test
    
    # Test health endpoint (if available)
    - apk add --no-cache curl || true
    - curl -f http://localhost:8080/actuator/health || echo "Health endpoint not available"
    
    # Cleanup
    - docker stop $APP_NAME-test
    - docker rm $APP_NAME-test
    
    - echo "✅ Container test completed"
  only:
    - main
    - master
    - develop

# ==================== DEPLOYMENT (Self-Hosted Runner Only) ====================
# Note: These stages require a self-hosted GitLab Runner with Docker access
# They will not work with GitLab's shared runners

deploy-staging:
  stage: deploy-staging
  image: docker:latest
  needs:
    - push-to-registry
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "⚠️ This stage requires a self-hosted GitLab Runner"
    - echo "Deploying to staging environment..."
    
    # Pull latest image from registry
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    # Stop and remove existing staging container
    - docker stop $APP_NAME-staging || true
    - docker rm $APP_NAME-staging || true
    
    # Run new staging container
    - docker run -d --name $APP_NAME-staging -p $STAGING_PORT:8080 -e SPRING_PROFILES_ACTIVE=staging $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    - echo "✅ Staging deployed on port $STAGING_PORT"
    - sleep 30
    - docker ps | grep $APP_NAME-staging
  environment:
    name: staging
    url: http://localhost:8080
  tags:
    - self-hosted
  when: manual
  only:
    - main
    - master
    - develop

deploy-production:
  stage: deploy-production
  image: docker:latest
  needs:
    - push-to-registry
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "⚠️ This stage requires a self-hosted GitLab Runner"
    - echo "Deploying to production environment..."
    
    # Pull latest image from registry
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    # Stop and remove existing production container
    - docker stop $APP_NAME-prod || true
    - docker rm $APP_NAME-prod || true
    
    # Run new production container
    - docker run -d --name $APP_NAME-prod -p $PROD_PORT:8080 -e SPRING_PROFILES_ACTIVE=prod --restart unless-stopped $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    
    - echo "✅ Production deployed on port $PROD_PORT"
    - sleep 30
    - docker ps | grep $APP_NAME-prod
  environment:
    name: production
    url: http://localhost:8081
  tags:
    - self-hosted
  when: manual
  only:
    - main
    - master

# ==================== CLEANUP ====================

cleanup:
  stage: deploy-production
  image: docker:latest
  script:
    - echo "Cleaning up old Docker images..."
    - docker image prune -f
    - echo "✅ Cleanup completed"
  when: always
  only:
    - main
    - master